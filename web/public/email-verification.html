<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificaci√≥n de Email - FamilyDash</title>
  <meta name="description" content="Verifica tu email para acceder a FamilyDash">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.8);
      --shadow-primary: 0 25px 50px rgba(0, 0, 0, 0.25);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--primary-gradient);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 40px;
      box-shadow: var(--shadow-primary);
      text-align: center;
    }

    .logo {
      margin-bottom: 32px;
    }

    .logo img {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      margin-bottom: 16px;
    }

    .logo h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .email-icon {
      font-size: 64px;
      margin-bottom: 24px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #fbbf24;
    }

    .subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .user-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .verification-status {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .status-text {
      font-size: 16px;
      margin-bottom: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 16px 32px;
      border-radius: 12px;
      background: var(--success-gradient);
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 16px;
      margin: 8px;
      transition: var(--transition);
      border: none;
      cursor: pointer;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .btn-warning {
      background: var(--warning-gradient);
    }

    .btn-warning:hover {
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    }

    .loading {
      display: none;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .container {
        padding: 24px;
        margin: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <img src="/assets/brand/logo-256.png" alt="FamilyDash" class="logo-image">
      <h1>FamilyDash</h1>
    </div>

    <div class="email-icon">üìß</div>
    
    <h2>Verificaci√≥n de Email</h2>
    <p class="subtitle">
      Necesitamos verificar tu direcci√≥n de correo electr√≥nico para continuar
    </p>

    <div class="user-info" id="userInfo">
      <strong>Usuario actual:</strong> <span id="userEmail">Cargando...</span><br>
      <strong>Estado:</strong> <span id="verificationStatus">Verificando...</span>
    </div>

    <div class="verification-status" id="verificationStatusDiv">
      <div class="status-icon" id="statusIcon">‚è≥</div>
      <div class="status-text" id="statusText">Verificando estado del email...</div>
    </div>

    <button class="btn btn-warning" id="resendButton" onclick="resendVerification()">
      <span class="loading" id="resendLoading"></span>
      <span id="resendText">üì§ Reenviar Email de Verificaci√≥n</span>
    </button>

    <button class="btn btn-secondary" id="continueButton" onclick="continueWithoutVerification()" style="display: none;">
      <span class="loading" id="continueLoading"></span>
      <span id="continueText">üöÄ Continuar Sin Verificar (Temporal)</span>
    </button>

    <a href="/" class="btn btn-secondary">
      üè† Volver al Inicio
    </a>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    let currentUser = null;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBqZSqW2ZU1EZldEuc0rktxMuSYi1hleq8",
      authDomain: "family-dash-15944.firebaseapp.com",
      projectId: "family-dash-15944",
      storageBucket: "family-dash-15944.firebasestorage.app",
      messagingSenderId: "3950658017",
      appId: "1:3950658017:web:9d4d2ddea39f8a785e12a0"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    async function loadUserInfo() {
      try {
        currentUser = await new Promise((resolve) => {
          const unsubscribe = auth.onAuthStateChanged((user) => {
            unsubscribe();
            resolve(user);
          });
        });

        if (!currentUser) {
          window.location.href = '/login';
          return;
        }

        document.getElementById('userEmail').textContent = currentUser.email;
        
        // Check verification status
        await checkVerificationStatus();

      } catch (error) {
        console.error('Error loading user info:', error);
        document.getElementById('userEmail').textContent = 'Error cargando informaci√≥n';
      }
    }

    async function checkVerificationStatus() {
      try {
        await currentUser.reload();
        const isVerified = currentUser.emailVerified;
        
        if (isVerified) {
          document.getElementById('verificationStatus').textContent = '‚úÖ Verificado';
          document.getElementById('statusIcon').textContent = '‚úÖ';
          document.getElementById('statusText').textContent = '¬°Tu email ha sido verificado! Puedes continuar al dashboard.';
          document.getElementById('continueButton').style.display = 'inline-flex';
          document.getElementById('resendButton').style.display = 'none';
          
          // Auto-redirect after 3 seconds
          setTimeout(() => {
            window.location.href = '/dashboard-redirect.html';
          }, 3000);
        } else {
          document.getElementById('verificationStatus').textContent = '‚ùå No verificado';
          document.getElementById('statusIcon').textContent = 'üìß';
          document.getElementById('statusText').textContent = 'Tu email a√∫n no ha sido verificado. Revisa tu bandeja de entrada y spam.';
          document.getElementById('continueButton').style.display = 'inline-flex';
        }

      } catch (error) {
        console.error('Error checking verification status:', error);
      }
    }

    async function resendVerification() {
      const button = document.getElementById('resendButton');
      const loading = document.getElementById('resendLoading');
      const text = document.getElementById('resendText');

      button.disabled = true;
      loading.style.display = 'inline-block';
      text.textContent = 'Enviando...';

      try {
        const actionCodeSettings = {
          url: 'https://family-dash-15944.web.app/dashboard-redirect.html',
          handleCodeInApp: false,
        };

        await currentUser.sendEmailVerification(actionCodeSettings);
        text.textContent = '‚úÖ Email enviado!';
        
        setTimeout(() => {
          text.textContent = 'üì§ Reenviar Email de Verificaci√≥n';
          button.disabled = false;
          loading.style.display = 'none';
        }, 3000);

      } catch (error) {
        console.error('Error sending verification email:', error);
        text.textContent = '‚ùå Error enviando email';
        
        setTimeout(() => {
          text.textContent = 'üì§ Reenviar Email de Verificaci√≥n';
          button.disabled = false;
          loading.style.display = 'none';
        }, 3000);
      }
    }

    async function continueWithoutVerification() {
      const button = document.getElementById('continueButton');
      const loading = document.getElementById('continueLoading');
      const text = document.getElementById('continueText');

      button.disabled = true;
      loading.style.display = 'inline-block';
      text.textContent = 'Continuando...';

      // Update user in Firestore to mark as verified for testing
      try {
        const db = firebase.firestore();
        await db.collection('users').doc(currentUser.uid).update({
          emailVerified: true,
          verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
          verifiedForTesting: true,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        // Force reload user to update verification status
        await currentUser.reload();
        
        text.textContent = '‚úÖ Continuando...';
        
        setTimeout(() => {
          window.location.href = '/dashboard-redirect.html';
        }, 1500);

      } catch (error) {
        console.error('Error updating verification status:', error);
        text.textContent = '‚ùå Error';
        
        setTimeout(() => {
          text.textContent = 'üöÄ Continuar Sin Verificar (Temporal)';
          button.disabled = false;
          loading.style.display = 'none';
        }, 3000);
      }
    }

    // Load user info when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
    });
  </script>
</body>
</html>

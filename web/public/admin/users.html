<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Usuarios - Admin Dashboard</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="/favicon.svg">
  <link rel="stylesheet" href="../css/admin-styles.css">
  <style>
    /* Inherit styles from dashboard */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #667eea;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #334155;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    
    .dashboard-container {
      display: flex;
      min-height: 100vh;
    }
    
    .main-content {
      flex: 1;
      padding: 32px;
      margin-left: 260px;
    }
    
    .header {
      margin-bottom: 32px;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    
    .header p {
      color: var(--text-secondary);
    }
    
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }
    
    .search-box {
      flex: 1;
      min-width: 300px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .filters {
      display: flex;
      gap: 12px;
    }
    
    .filter-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .filter-btn:hover,
    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      text-align: left;
      padding: 12px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    td {
      padding: 16px 12px;
      border-bottom: 1px solid var(--border);
    }
    
    tr:hover {
      background: var(--bg-tertiary);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-superadmin { background: var(--warning); color: #000; }
    .badge-admin { background: #8B5CF6; color: white; }
    .badge-co_admin { background: #3B82F6; color: white; }
    .badge-member { background: var(--success); color: white; }
    .badge-viewer { background: #6B7280; color: white; }
    .badge-verified { background: var(--success); color: white; }
    .badge-pending { background: var(--warning); color: #000; }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-icon {
      padding: 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .btn-icon:hover {
      transform: scale(1.1);
    }
    
    .btn-edit {
      background: var(--primary);
    }
    
    .btn-delete {
      background: var(--danger);
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 64px;
      font-size: 18px;
      color: var(--text-secondary);
    }
    
    .spinner {
      border: 4px solid var(--bg-tertiary);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-right: 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
    }
    
    .modal-header {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 20px;
    }
    
    .modal-body {
      margin-bottom: 24px;
    }
    
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar (Same as dashboard) -->
    <aside class="sidebar" style="width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); padding: 24px; position: fixed; height: 100vh; overflow-y: auto;">
      <div style="font-size: 24px; font-weight: 700; margin-bottom: 32px; color: var(--primary); display: flex; align-items: center; gap: 12px;">
        <span>üè†</span>
        <span>FamilyDash Admin</span>
      </div>
      
      <div class="user-info" id="userInfo" style="background: var(--bg-tertiary); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
        <div class="user-email" id="userEmail" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Cargando...</div>
        <span class="user-role" id="userRole">...</span>
      </div>
      
      <nav style="margin-bottom: 32px;">
        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 12px;">Dashboard</div>
        <ul style="list-style: none;">
          <li style="margin-bottom: 4px;">
            <a href="/admin/dashboard" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>üìä</span>
              <span>Overview</span>
            </a>
          </li>
          <li style="margin-bottom: 4px;">
            <a href="/admin/analytics" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>üìà</span>
              <span>Analytics Global</span>
            </a>
          </li>
        </ul>
      </nav>
      
      <nav style="margin-bottom: 32px;" id="superAdminNav">
        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 12px;">Administraci√≥n</div>
        <ul style="list-style: none;">
          <li style="margin-bottom: 4px;">
            <a href="/admin/users" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; background: var(--primary); color: white; text-decoration: none;">
              <span>üë•</span>
              <span>Usuarios</span>
            </a>
          </li>
          <li style="margin-bottom: 4px;">
            <a href="/admin/families" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
              <span>Familias</span>
            </a>
          </li>
          <li style="margin-bottom: 4px;">
            <a href="/admin/content" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>üìù</span>
              <span>Contenido (Blog)</span>
            </a>
          </li>
          <li style="margin-bottom: 4px;">
            <a href="/admin/system" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>‚öôÔ∏è</span>
              <span>Configuraci√≥n</span>
            </a>
          </li>
        </ul>
      </nav>
      
      <nav>
        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 12px;">Sistema</div>
        <ul style="list-style: none;">
          <li style="margin-bottom: 4px;">
            <a href="/" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>üåê</span>
              <span>Ver Sitio Web</span>
            </a>
          </li>
          <li style="margin-bottom: 4px;">
            <a href="#" onclick="handleLogout(); return false;" style="display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-radius: 8px; color: var(--text-secondary); text-decoration: none;">
              <span>üö™</span>
              <span>Cerrar Sesi√≥n</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="main-content">
      <div class="header">
        <h1>Gesti√≥n de Usuarios</h1>
        <p>Administra todos los usuarios de la plataforma</p>
      </div>
      
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search-box">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput"
            placeholder="üîç Buscar por email, nombre o ID..." 
            onkeyup="filterUsers()"
          >
        </div>
        
        <div class="filters">
          <button class="filter-btn active" onclick="filterByRole('all')">Todos</button>
          <button class="filter-btn" onclick="filterByRole('superadmin')">Super Admins</button>
          <button class="filter-btn" onclick="filterByRole('admin')">Admins</button>
          <button class="filter-btn" onclick="filterByRole('member')">Members</button>
          <button class="filter-btn" onclick="filterByRole('viewer')">Viewers</button>
        </div>
      </div>
      
      <!-- Stats -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Total Usuarios</div>
          <div style="font-size: 32px; font-weight: 800;" id="totalUsersCount">0</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Verificados</div>
          <div style="font-size: 32px; font-weight: 800; color: var(--success);" id="verifiedCount">0</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Pendientes</div>
          <div style="font-size: 32px; font-weight: 800; color: var(--warning);" id="pendingCount">0</div>
        </div>
        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
          <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">Activos (7d)</div>
          <div style="font-size: 32px; font-weight: 800; color: var(--primary);" id="activeCount">0</div>
        </div>
      </div>
      
      <!-- Users Table -->
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Familia</th>
                <th>Registrado</th>
                <th>√öltimo Acceso</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <tr>
                <td colspan="8" class="loading">
                  <div class="spinner"></div>
                  Cargando usuarios...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit User Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">Editar Usuario</div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email</label>
          <input type="text" id="editEmail" readonly style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre</label>
          <input type="text" id="editName" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rol</label>
          <select id="editRole" style="width: 100%; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
            <option value="viewer">Viewer</option>
            <option value="member">Member</option>
            <option value="co_admin">Co-Admin</option>
            <option value="admin">Admin</option>
            <option value="superadmin">Super Admin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveUserChanges()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header" style="color: var(--danger);">‚ö†Ô∏è Eliminar Usuario</div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de que quieres eliminar este usuario?</p>
        <p style="margin-top: 12px; color: var(--text-secondary); font-size: 14px;">Esta acci√≥n no se puede deshacer. Se eliminar√°n todos los datos del usuario.</p>
        <p style="margin-top: 12px; font-weight: 600;" id="deleteUserEmail"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmDelete()">S√≠, Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Firebase Auth Integration -->
  <script src="/js/firebase-auth.js"></script>

  <script>
    let allUsers = [];
    let currentFilter = 'all';
    let currentEditUserId = null;
    let currentDeleteUserId = null;
    
    // Check auth and load data
    async function init() {
      const authData = await checkAuth();
      if (!authData) return;
      
      const { user, isSuperAdmin } = authData;
      
      if (!isSuperAdmin) {
        alert('Solo Super Admins pueden acceder a la gesti√≥n de usuarios.');
        window.location.href = '/admin/dashboard';
        return;
      }
      
      await loadUserInfo();
      await loadAllUsers();
    }
    
    // Load user info
    async function loadUserInfo() {
      const user = await window.FamilyDashAuth.getCurrentUser();
      const userData = await window.FamilyDashAuth.getUserData(user.uid);
      const isSuperAdmin = await window.FamilyDashAuth.isSuperAdmin(user.uid);
      
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('userRole').textContent = isSuperAdmin ? 'Super Admin' : 'Admin';
      document.getElementById('userRole').className = isSuperAdmin ? 'user-role badge-superadmin' : 'user-role badge-admin';
    }
    
    // Load all users
    async function loadAllUsers() {
      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
        
        allUsers = [];
        snapshot.forEach((doc) => {
          allUsers.push({
            id: doc.id,
            ...doc.data(),
          });
        });
        
        updateStats();
        renderUsers();
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersTable').innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--danger);">Error cargando usuarios: ' + error.message + '</td></tr>';
      }
    }
    
    // Update stats
    function updateStats() {
      const total = allUsers.length;
      const verified = allUsers.filter(u => u.emailVerified).length;
      const pending = total - verified;
      
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const active = allUsers.filter(u => u.lastActive && new Date(u.lastActive.toDate()) > sevenDaysAgo).length;
      
      document.getElementById('totalUsersCount').textContent = total;
      document.getElementById('verifiedCount').textContent = verified;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('activeCount').textContent = active;
    }
    
    // Render users table
    function renderUsers() {
      const tableBody = document.getElementById('usersTable');
      
      let filteredUsers = allUsers;
      
      // Filter by role
      if (currentFilter !== 'all') {
        filteredUsers = allUsers.filter(u => (u.role || 'member') === currentFilter);
      }
      
      // Filter by search
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm) {
        filteredUsers = filteredUsers.filter(u => 
          (u.email || '').toLowerCase().includes(searchTerm) ||
          (u.displayName || '').toLowerCase().includes(searchTerm) ||
          (u.uid || '').toLowerCase().includes(searchTerm)
        );
      }
      
      tableBody.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">No se encontraron usuarios</td></tr>';
        return;
      }
      
      filteredUsers.forEach((user) => {
        const row = document.createElement('tr');
        
        const familyName = user.familyId ? `Familia ${user.familyId.substring(0, 8)}` : '-';
        const createdDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString('es-ES') : '-';
        const lastActive = user.lastActive ? new Date(user.lastActive.toDate()).toLocaleDateString('es-ES') : '-';
        
        row.innerHTML = `
          <td>${user.email || '-'}</td>
          <td>${user.displayName || '-'}</td>
          <td><span class="badge badge-${user.role || 'member'}">${user.role || 'member'}</span></td>
          <td><span class="badge badge-${user.emailVerified ? 'verified' : 'pending'}">${user.emailVerified ? '‚úÖ Verificado' : '‚è≥ Pendiente'}</span></td>
          <td>${familyName}</td>
          <td>${createdDate}</td>
          <td>${lastActive}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-edit" onclick="editUser('${user.id}')" title="Editar">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" onclick="deleteUser('${user.id}')" title="Eliminar">üóëÔ∏è</button>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
    }
    
    // Filter functions
    function filterByRole(role) {
      currentFilter = role;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      renderUsers();
    }
    
    function filterUsers() {
      renderUsers();
    }
    
    // Edit user
    function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      
      currentEditUserId = userId;
      
      document.getElementById('editEmail').value = user.email || '';
      document.getElementById('editName').value = user.displayName || '';
      document.getElementById('editRole').value = user.role || 'member';
      
      document.getElementById('editModal').classList.add('show');
    }
    
    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEditUserId = null;
    }
    
    async function saveUserChanges() {
      if (!currentEditUserId) return;
      
      const newName = document.getElementById('editName').value;
      const newRole = document.getElementById('editRole').value;
      
      try {
        const db = firebase.firestore();
        await db.collection('users').doc(currentEditUserId).update({
          displayName: newName,
          role: newRole,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        
        alert('Usuario actualizado exitosamente');
        closeEditModal();
        await loadAllUsers();
      } catch (error) {
        console.error('Error updating user:', error);
        alert('Error actualizando usuario: ' + error.message);
      }
    }
    
    // Delete user
    function deleteUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;
      
      currentDeleteUserId = userId;
      document.getElementById('deleteUserEmail').textContent = user.email;
      document.getElementById('deleteModal').classList.add('show');
    }
    
    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
      currentDeleteUserId = null;
    }
    
    async function confirmDelete() {
      if (!currentDeleteUserId) return;
      
      try {
        const db = firebase.firestore();
        
        // Delete user document
        await db.collection('users').doc(currentDeleteUserId).delete();
        
        // Note: Deleting Firebase Auth user requires admin SDK (Cloud Function)
        alert('Usuario eliminado de Firestore. Nota: Para eliminar completamente del Auth, usa Cloud Functions.');
        
        closeDeleteModal();
        await loadAllUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('Error eliminando usuario: ' + error.message);
      }
    }
    
    // Check auth
    async function checkAuth() {
      const user = await window.FamilyDashAuth.getCurrentUser();
      
      if (!user) {
        window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        return null;
      }
      
      const isSuperAdmin = await window.FamilyDashAuth.isSuperAdmin(user.uid);
      const isFamilyAdmin = await window.FamilyDashAuth.isFamilyAdmin(user.uid);
      
      if (!isSuperAdmin && !isFamilyAdmin) {
        alert('No tienes permisos para acceder al panel de administraci√≥n.');
        window.location.href = '/';
        return null;
      }
      
      return { user, isSuperAdmin, isFamilyAdmin };
    }
    
    // Logout
    async function handleLogout() {
      if (confirm('¬øCerrar sesi√≥n?')) {
        await window.FamilyDashAuth.logout();
        window.location.href = '/login';
      }
    }
    
    // Initialize
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
